<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Fitness Chatbot</title>
  <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gradient-to-r from-gray-100 via-blue-50 to-purple-100 flex items-center justify-center min-h-screen font-sans">

  <div class="w-full max-w-4xl bg-white rounded-2xl shadow-xl flex flex-col h-[90vh] overflow-hidden">

    <!-- Header -->
    <div class="flex justify-between items-center bg-gradient-to-r from-blue-600 to-purple-600 text-white px-6 py-4">
      <h1 class="font-bold text-xl">üèãÔ∏è Fitness Chatbot</h1>
      <!-- Logout -->
      <form method="post">
        {% csrf_token %}
        <input type="hidden" name="message" value="Logout">
        <button type="submit"
                class="px-4 py-2 bg-red-500 text-white rounded-full hover:bg-red-600 transition">
          Logout
        </button>
      </form>
    </div>

    <!-- Chat Window -->
    <div class="flex-1 p-6 overflow-y-auto bg-gradient-to-b from-gray-50 to-gray-100" id="chat-box">
      <p class="text-gray-500 text-center italic">‚è≥ Loading chat history...</p>
    </div>

    <!-- Input Box -->
    <div class="flex border-t p-4 bg-white">
      <input type="text" id="msg" placeholder="Type your message..."
             class="flex-1 px-4 py-3 border rounded-full shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-400 transition"
             onkeypress="if(event.key === 'Enter'){sendMessage();}">
      <button onclick="sendMessage()"
              class="ml-3 px-6 py-3 bg-blue-600 text-white rounded-full hover:bg-blue-700 transition">
        Send
      </button>
    </div>
  </div>

  <!-- Chat Logic -->
  <script>
    const chatBox = document.getElementById("chat-box");

    // Send message via AJAX
    async function sendMessage(customMessage=null) {
      const input = document.getElementById("msg");
      const message = customMessage || input.value.trim();
      if (!message) return;

      // Show user message instantly
      chatBox.innerHTML += `
        <div class="mb-3 text-right">
          <span class="inline-block px-4 py-2 rounded-2xl max-w-lg break-words shadow bg-blue-500 text-white rounded-br-none">
            ${message}
          </span>
        </div>
      `;
      input.value = "";
      chatBox.scrollTop = chatBox.scrollHeight;

      // Show thinking bubble
      const loadingId = Date.now();
      chatBox.innerHTML += `
        <div id="loading-${loadingId}" class="mb-3 text-left animate-pulse">
          <span class="inline-block bg-gray-300 text-gray-700 px-4 py-2 rounded-2xl rounded-bl-none shadow">
            ü§ñ Thinking...
          </span>
        </div>
      `;
      chatBox.scrollTop = chatBox.scrollHeight;

      // Send to backend
      const res = await fetch("/app/chat_api/", {
        method: "POST",
        headers: {
          "Content-Type": "application/json",
          "X-CSRFToken": getCookie("csrftoken")
        },
        body: JSON.stringify({ message: message })
      });
      const data = await res.json();

      // Replace thinking bubble with reply
      const botMessageId = `bot-${loadingId}`;
      document.getElementById(`loading-${loadingId}`).outerHTML = `
        <div id="${botMessageId}" class="mb-3 text-left">
          <span class="inline-block bg-gray-200 text-gray-900 px-4 py-2 rounded-2xl max-w-lg break-words shadow rounded-bl-none">
            ü§ñ ${data.reply}
          </span>
        </div>
      `;
      chatBox.scrollTop = chatBox.scrollHeight;

      // ‚úÖ If backend says refresh history, load it
      if (data.refresh_history) {
        loadHistory();
      }

      // Normalize reply text
      const cleanReply = (data.reply || "").toLowerCase();

      // ‚úÖ Registration prompt (Yes/No)
      if (cleanReply.includes("would you like to register")) {
        chatBox.innerHTML += `
          <div class="flex space-x-3 mt-3">
            <button onclick="sendMessage('Yes')" 
                    class="px-5 py-2 bg-green-500 text-white rounded-full hover:bg-green-600 transition">
              Yes
            </button>
            <button onclick="sendMessage('No')" 
                    class="px-5 py-2 bg-red-500 text-white rounded-full hover:bg-red-600 transition">
              No
            </button>
          </div>
        `;
        chatBox.scrollTop = chatBox.scrollHeight;
      }

      // ‚úÖ Wrong OTP prompt (Edit / Resend / Retry)
      if (cleanReply.includes("wrong otp")) {
        chatBox.innerHTML += `
          <div class="flex space-x-3 mt-3">
            <button onclick="sendMessage('Edit Number')" 
                    class="px-5 py-2 bg-blue-500 text-white rounded-full hover:bg-blue-600 transition">
              Edit Number
            </button>
            <button onclick="sendMessage('Resend OTP')" 
                    class="px-5 py-2 bg-purple-500 text-white rounded-full hover:bg-purple-600 transition">
              Resend OTP
            </button>
            <button onclick="sendMessage('Retry')" 
                    class="px-5 py-2 bg-yellow-500 text-white rounded-full hover:bg-yellow-600 transition">
              Retry
            </button>
          </div>
        `;
        chatBox.scrollTop = chatBox.scrollHeight;

        // ‚úÖ Auto-focus input box for retry
        setTimeout(() => document.getElementById("msg").focus(), 200);
      }
    }

    // Load history dynamically
    async function loadHistory() {
      const res = await fetch("/app/chat_history_api/");
      const data = await res.json();
      chatBox.innerHTML = ""; // clear placeholder

      if (data.history && data.history.length > 0) {
        data.history.forEach(chat => {
          chatBox.innerHTML += `
            <div class="mb-3 ${chat.sender === 'user' ? 'text-right' : ''}">
              <span class="inline-block px-4 py-2 rounded-2xl max-w-lg break-words shadow
                           ${chat.sender === 'user'
                             ? 'bg-blue-500 text-white rounded-br-none'
                             : 'bg-gray-200 text-gray-900 rounded-bl-none'}">
                ${chat.message}
              </span>
            </div>
          `;
        });
      } else {
        chatBox.innerHTML = `<p class="text-gray-500 text-center italic">üëâ Start by entering your number üì±</p>`;
      }
      chatBox.scrollTop = chatBox.scrollHeight;
    }

    // CSRF helper
    function getCookie(name) {
      let cookieValue = null;
      if (document.cookie && document.cookie !== "") {
        const cookies = document.cookie.split(";");
        for (let i = 0; i < cookies.length; i++) {
          const cookie = cookies[i].trim();
          if (cookie.substring(0, name.length + 1) === (name + "=")) {
            cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
            break;
          }
        }
      }
      return cookieValue;
    }

    // Load history on page load
    loadHistory();
  </script>
</body>
</html>
